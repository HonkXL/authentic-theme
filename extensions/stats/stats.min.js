"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err){_d=true;_e=err;}finally{try{if(!_n&&_i["return"])_i["return"]();}finally{if(_d)throw _e;}}return _arr;}return function(arr,i){if(Array.isArray(arr)){return arr;}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i);}else{throw new TypeError("Invalid attempt to destructure non-iterable instance");}};}();var stats={sys:{error:0,activating:0,requery:null,socket:null,getSocketDefs:function getSocketDefs(){return{session:session.server.data("session-hash"),paused:0,history:this.request_history(),interval:this.timeout(),disable:!this.enabled(),shutdown:settings_sysinfo_real_time_shutdown_on_last?1:0};},fetch:function fetch(){if(this.enabled()){var socketData=this.getSocketDefs();var history=this.request_history();if(history||this.request_history._){this.request_history._=!this.request_history._;socketData.history=+this.request_history._;this.socket.send(JSON.stringify(socketData));}}},request_history:function request_history(){return document.querySelector("["+this.selector.chart.loader+"]")?1:0;},timeout:function timeout(){return settings_sysinfo_real_time_run_rate/1000;},active:function active(){return theme.visibility.get();},stored_length:function stored_length(){return settings_sysinfo_real_time_stored_duration;},enabled:function enabled(){return settings_sysinfo_real_time_status?1:0;},disable:function disable(){if(this.socket){var socketData=this.getSocketDefs();socketData.paused=1;this.socket.send(JSON.stringify(socketData));}},enable:function enable(){if(this.enabled()){if(this.socket){this.socket.send(JSON.stringify(this.getSocketDefs()));}else{this.activate();}}},shutdown:function shutdown(){if(this.socket){var socketData=this.getSocketDefs();socketData.disable=1;this.socket.send(JSON.stringify(socketData));}},block:theme_updating,_:{prefix:v___location_prefix,error:connection_error,language:theme_language,convert:{size:Convert.nice_size},chart:Chartist,dayjs:dayjs,locale:{time:config_portable_theme_locale_format_time,offset:function offset(){return get_utc_offset();}}},selector:{chart:{container:{parent:"live_stats",data:"data-chart"},loader:"data-charts-loader"},collapse:"collapse",dashboard:"system-status",slider:"info-container",piechart:"piechart"},activate:function activate(){if(this.activating++){return;}if(this.block()){return;}if(this.socket){return;}$.ajax({context:this,url:this._.prefix+"/stats.cgi",error:function error(){var _this=this;this.activating=0;if(this.error++>3){return;}!this.requery&&(this.requery=setTimeout(function(){_this.requery=null;_this.activate();},this.timeout()*1000));},success:function success(data){var _this2=this;if(data.success){console.warn("WebSocket connection opened",data);this.socket=new WebSocket(data.socket);this.socket.onopen=function(){_this2.activating=0;_this2.socket.send(JSON.stringify(_this2.getSocketDefs()));};this.socket.onmessage=function(event){var message=JSON.parse(event.data);_this2.render(message);_this2.active()&&_this2.fetch();};this.socket.onclose=function(){console.warn("WebSocket connection closed");setTimeout(function(){_this2.socket=null;_this2.activating=0;_this2.enable();},_this2.timeout());};}else{this.activating=0;}this.error=0;},dataType:"json"});},render:function render(data){var _this3=this;Object.entries(data).map(function(_ref){var _ref2=_slicedToArray(_ref,2),target=_ref2[0],data=_ref2[1];var v=parseInt(data),vo=(typeof data==="undefined"?"undefined":_typeof(data))==="object"?data[data.length-1]:false,vt=vo?vo:v,$pc=$("#"+_this3.selector.dashboard+" ."+_this3.selector.piechart+"[data-charts*=\""+target+"\"]"),$lc=$("."+_this3.selector.slider+" ."+target+"_percent"),$od=$("#"+_this3.selector.dashboard+" span[data-id=\"sysinfo_"+target+"\"], \n                             ."+_this3.selector.slider+" span[data-data=\""+target+"\"]"),cached=target==="_history"?2:target==="_current"?1:0;if(Number.isInteger(v)){if($pc.length){var piechart=$pc.data("easyPieChart");piechart&&piechart.update(v);}if($lc.length){$lc.find(".bar").attr("style","width:"+v+"%");var $dp=$lc.find(".description"),$lb=$dp.text().split(":")[0];$dp.attr("title",vo).text($lb+": "+v+"% ("+vo+")");}if($od.length){if($od.find("a").length){$od.find("a").text(vt);}else{$od.text(vt);}}}if(cached){var lds=_this3.selector.chart.container.parent+"-"+_this3.selector.collapse,ld=$("#"+lds).find("["+_this3.selector.chart.loader+"]");Object.entries(data).map(function(_ref3){var _ref4=_slicedToArray(_ref3,2),_type=_ref4[0],array=_ref4[1];var options={chart:{type:function type(){return _type==="proc"||_type==="disk"||_type==="net";},bandwidth:function bandwidth(){return _type==="disk"||_type==="net";},fill:function fill(){return this.type()?false:true;},high:function high(){return this.type()?undefined:100;},threshold:function threshold(){return this.type()?-1:50;},height:"100px"}},lg=_this3._.language(_this3.selector.chart.container.parent+"_"+_type),tg=$("#"+lds).find("["+_this3.selector.chart.container.data+"="+_type+"]"),sr=[{name:"series-"+_type,data:array}];if(!tg.length){return;}if(array[0]&&_typeof(array[0].y)==="object"){sr=[];array[0].y.forEach(function(x,i){var data=[];array.forEach(function(n){data.push({data:{x:n.x,y:n.y[i]}});});sr.push({name:"series-"+_type+"-"+i,data:data});});}if(tg[0]&&tg[0].textContent){if(cached===1){var lf=parseInt(_this3.stored_length());if(lf<300||lf>86400){lf=600;}var tdata=sr,cdata=_this3["chart_"+_type].data.series,cdata_start=void 0,cdata_end=void 0,cdata_ready=new Promise(function(resolve){tdata.forEach(function(d,i,a){cdata_start=cdata[i].data[0].x||cdata[i].data[0].data.x;cdata_end=cdata[i].data[cdata[i].data.length-1].x||cdata[i].data[cdata[i].data.length-1].data.x;cdata[i].data.push(d.data[0]);if(cdata_end-cdata_start>lf){cdata[i].data.shift();}if(i===a.length-1){resolve();}});});cdata_ready.then(function(){_this3["chart_"+_type].update({series:cdata});});}}else if(cached===2){_this3["chart_"+_type]=new _this3._.chart.Line(tg[0],{series:sr},{axisX:{type:_this3._.chart.FixedScaleAxis,divisor:12,labelInterpolationFnc:function labelInterpolationFnc(value){return _this3._.dayjs(value*1000).utcOffset(_this3._.locale.offset()).format(_this3._.locale.time);}},height:options.chart.height,showArea:options.chart.fill(),showPoint:!options.chart.fill(),high:options.chart.high(),low:0,fullWidth:true,chartPadding:{left:25},axisY:{onlyInteger:true,labelInterpolationFnc:function labelInterpolationFnc(value){if(options.chart.fill()){return value?value+"%":value;}else if(options.chart.bandwidth(value)){if(_type==="net"){return value?_this3._.convert.size(value,{fixed:0,bits:1,round:1}):value;}return value?_this3._.convert.size(value*1000,{fixed:0,round:1}):value;}else{return value;}}},plugins:[_this3._.chart.plugins.ctAxisTitle({axisY:{axisTitle:lg,axisClass:"ct-axis-title",offset:{x:0,y:9},flipTitle:true}}),_this3._.chart.plugins.ctThreshold({threshold:options.chart.threshold()})]});_this3["chart_"+_type].on("created",function(){return ld.remove();});}});}});}}};
